name: Auto Build and Release

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
      - 'scripts/**'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Calculate version
        id: version
        shell: pwsh
        run: |
          $latestTag = git describe --tags --abbrev=0 2>$null
          if (-not $latestTag) {
            $newVer = "1.0.0"
          } else {
            $ver = $latestTag -replace '^v', ''
            $parts = $ver.Split('.')
            $major = [int]$parts[0]
            $minor = [int]$parts[1]
            $patch = [int]$parts[2] + 1
            $msg = git log -1 --pretty=%B
            if ($msg -match '(?i)^(breaking|major)') {
              $major++; $minor = 0; $patch = 0
            } elseif ($msg -match '(?i)^(feat|feature|minor)') {
              $minor++; $patch = 0
            }
            $newVer = "$major.$minor.$patch"
          }
          echo "VERSION=$newVer" >> $env:GITHUB_OUTPUT
          echo "TAG=v$newVer" >> $env:GITHUB_OUTPUT
          Write-Host "Version: v$newVer"

      - name: Publish
        shell: pwsh
        run: |
          dotnet publish "ScreenshotTranslator\src\ScreenshotTranslator\ScreenshotTranslator.csproj" `
            -c Release -r win-x64 --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:Version=${{ steps.version.outputs.VERSION }} `
            -o "./publish"

      - name: Create ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path "./publish/*" `
            -DestinationPath "./ScreenshotTranslator-${{ steps.version.outputs.TAG }}-Windows-x64.zip" -Force

      - name: Generate changelog
        id: changelog
        shell: pwsh
        run: |
          $prevTag = git describe --tags --abbrev=0 2>$null
          if ($prevTag) {
            $log = git log --pretty=format:"- %s" "$prevTag..HEAD"
          } else {
            $log = git log --pretty=format:"- %s"
          }
          if (-not $log) { $log = "- Initial release" }
          $delimiter = "EOF_$(Get-Random)"
          echo "CHANGELOG<<$delimiter" >> $env:GITHUB_OUTPUT
          echo $log >> $env:GITHUB_OUTPUT
          echo "$delimiter" >> $env:GITHUB_OUTPUT

      - name: Create tag
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.TAG }}
          git push origin ${{ steps.version.outputs.TAG }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: "ScreenshotTranslator ${{ steps.version.outputs.TAG }}"
          body: |
            ## ScreenshotTranslator ${{ steps.version.outputs.TAG }}

            ### Download
            1. Download **ScreenshotTranslator-${{ steps.version.outputs.TAG }}-Windows-x64.zip**
            2. Extract to any folder
            3. Run **ScreenshotTranslator.exe**

            ### Hotkeys
            | Hotkey | Function |
            |--------|----------|
            | Ctrl+Shift+A | Region capture |
            | Ctrl+Shift+F | Fullscreen capture |
            | Ctrl+Shift+T | Capture and translate |
            | Ctrl+Shift+O | OCR recognition |

            ### Changes
            ${{ steps.changelog.outputs.CHANGELOG }}

            ---
            > Requires: Windows 10 1903+, no runtime needed
          files: |
            ./ScreenshotTranslator-${{ steps.version.outputs.TAG }}-Windows-x64.zip
          draft: false
          prerelease: false
