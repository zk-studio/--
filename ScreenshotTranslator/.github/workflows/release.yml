name: ğŸš€ å…¨è‡ªåŠ¨æ„å»ºå‘å¸ƒ

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
      - 'scripts/**'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: ç­¾å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£… .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: è‡ªåŠ¨è®¡ç®—ç‰ˆæœ¬å·
        id: version
        shell: pwsh
        run: |
          $latestTag = git describe --tags --abbrev=0 2>$null
          if (-not $latestTag) {
            $newVer = "1.0.0"
          } else {
            $ver = $latestTag -replace '^v', ''
            $parts = $ver.Split('.')
            $major = [int]$parts[0]
            $minor = [int]$parts[1]
            $patch = [int]$parts[2] + 1

            # commit message å†³å®šç‰ˆæœ¬å·é€’å¢æ–¹å¼
            $msg = git log -1 --pretty=%B
            if ($msg -match '(?i)^(breaking|major)') {
              $major++; $minor = 0; $patch = 0
            } elseif ($msg -match '(?i)^(feat|feature|minor)') {
              $minor++; $patch = 0
            }

            $newVer = "$major.$minor.$patch"
          }

          echo "VERSION=$newVer" >> $env:GITHUB_OUTPUT
          echo "TAG=v$newVer" >> $env:GITHUB_OUTPUT
          Write-Host "ğŸ“¦ å°†å‘å¸ƒç‰ˆæœ¬: v$newVer"

      - name: ç¼–è¯‘å‘å¸ƒ
        shell: pwsh
        run: |
          dotnet publish "src\ScreenshotTranslator\ScreenshotTranslator.csproj" `
            -c Release -r win-x64 --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:Version=${{ steps.version.outputs.VERSION }} `
            -o "./publish"

      - name: æ‰“åŒ… ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path "./publish/*" `
            -DestinationPath "./ScreenshotTranslator-${{ steps.version.outputs.TAG }}-Windows-x64.zip" -Force

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        shell: pwsh
        run: |
          $prevTag = git describe --tags --abbrev=0 2>$null
          if ($prevTag) {
            $log = git log --pretty=format:"- %s" "$prevTag..HEAD"
          } else {
            $log = git log --pretty=format:"- %s"
          }
          if (-not $log) { $log = "- åˆå§‹å‘å¸ƒ" }
          $delimiter = "EOF_$(Get-Random)"
          echo "CHANGELOG<<$delimiter" >> $env:GITHUB_OUTPUT
          echo $log >> $env:GITHUB_OUTPUT
          echo "$delimiter" >> $env:GITHUB_OUTPUT

      - name: åˆ›å»º Tag å¹¶æ¨é€
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.TAG }}
          git push origin ${{ steps.version.outputs.TAG }}

      - name: å‘å¸ƒåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: "ScreenshotTranslator ${{ steps.version.outputs.TAG }}"
          body: |
            ## ğŸ“¦ ScreenshotTranslator ${{ steps.version.outputs.TAG }}

            ### ğŸ“¥ å®‰è£…æ–¹æ³•
            1. ä¸‹è½½ä¸‹æ–¹ **ScreenshotTranslator-${{ steps.version.outputs.TAG }}-Windows-x64.zip**
            2. è§£å‹åˆ°ä»»æ„æ–‡ä»¶å¤¹
            3. åŒå‡» **ScreenshotTranslator.exe** å³å¯è¿è¡Œ

            ### âŒ¨ï¸ å¿«æ·é”®
            | å¿«æ·é”® | åŠŸèƒ½ |
            |--------|------|
            | `Ctrl+Shift+A` | åŒºåŸŸæˆªå›¾ |
            | `Ctrl+Shift+F` | å…¨å±æˆªå›¾ |
            | `Ctrl+Shift+T` | æˆªå›¾ç¿»è¯‘ |
            | `Ctrl+Shift+O` | OCRè¯†åˆ« |

            ### ğŸ“ æ›´æ–°å†…å®¹
            ${{ steps.changelog.outputs.CHANGELOG }}

            ---
            > ğŸ’» ç³»ç»Ÿè¦æ±‚ï¼šWindows 10 1903+ï¼Œæ— éœ€å®‰è£…ä»»ä½•è¿è¡Œæ—¶
          files: |
            ./ScreenshotTranslator-${{ steps.version.outputs.TAG }}-Windows-x64.zip
          draft: false
          prerelease: false
